---
import "../styles/global.css";
import App from "../components/App.tsx";
import { loadTimetable } from "../lib/loadTimetable";
import Analytics from "../components/Analytics.astro";

const timetable = await loadTimetable();
const site = import.meta.env.PUBLIC_SITE_URL ?? 'https://sakaimachi-bus.amida-des.com';
const base = import.meta.env.PUBLIC_BASE_PATH ?? '/';
const siteUrl = new URL(base, site).toString();
const pageSlug = 'tokyo-to-sakai/';
const canonicalUrl = new URL(pageSlug, siteUrl).toString();
const ogImage = siteUrl + "og.png";
const ogImageAlt = "東京発 境町行き高速バスの次発を伝えるOGP";
const ogImageHeight = "630";
const ogImageWidth = "1200";
const twitterHandle = "@gmkz_com";
const siteAuthor = "Amida Design（非公式）";
const keywords = [
  "東京 境町 バス",
  "王子駅 境町 高速バス",
  "東京駅 高速バス 境町",
  "境町行き 高速バス",
  "東京 境町 直行バス"
].join(", ");

const route = (timetable)?.routes?.find((r: any) => r.id === 'tokyo_to_sakai');
const trips = (route?.trips ?? []).slice(0, 6);
const stops = Array.isArray(route?.stops) ? route?.stops : [];

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "境町 ↔ 東京 高速バス",
      item: siteUrl
    },
    {
      "@type": "ListItem",
      position: 2,
      name: "東京 → 境町 時刻表",
      item: canonicalUrl
    }
  ]
};

const routeSchema = route ? {
  "@context": "https://schema.org",
  "@type": "PublicTransportRoute",
  name: "東京発 境町行き 高速バス",
  provider: {
    "@type": "Organization",
    name: "境町⇄東京 高速バス",
    url: siteUrl
  },
  routeCode: "tokyo-sakai",
  departureStation: {
    "@type": "BusStation",
    name: stops[0] ?? "東京駅八重洲南口"
  },
  arrivalStation: {
    "@type": "BusStation",
    name: stops[stops.length - 1] ?? "境町バスターミナル"
  },
  hasPart: {
    "@type": "ItemList",
    itemListElement: trips.map((trip: any, index: number) => ({
      "@type": "BusTrip",
      position: index + 1,
      name: `${trip.dep_tokyo} 発 → 境町 ${trip.arr_sakai} 着`,
      departureTime: trip.dep_tokyo,
      arrivalTime: trip.arr_sakai,
      departureBusStop: {
        "@type": "BusStop",
        name: "東京駅八重洲南口"
      },
      arrivalBusStop: {
        "@type": "BusStop",
        name: "境町バスターミナル"
      }
    }))
  }
} : null;

const pageSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  name: "東京 → 境町 高速バスの時刻表・次の便",
  description: "王子駅・東京駅から境町へ向かう高速バス（平日・土日祝ダイヤ）の次発や時刻表をまとめています。",
  url: canonicalUrl,
  inLanguage: "ja"
};

const jsonLd = [pageSchema, breadcrumbSchema, routeSchema].filter(Boolean);
const initialNowIso = new Date().toISOString();
const overviewUrl = siteUrl;
const sakaiToTokyoUrl = new URL('sakai-to-tokyo/', siteUrl).toString();
const faqUrl = new URL('faq/', siteUrl).toString();
const guideUrl = new URL('guide/', siteUrl).toString();
const manifestUrl = new URL('manifest.webmanifest', siteUrl).toString();
const serviceWorkerPath = new URL('sw.js', siteUrl).pathname;
---
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>東京 → 境町 高速バスの時刻表・次発案内 | 境町バスミニ</title>
    <meta name="description" content="東京駅・王子駅から境町へ向かう高速バスの次発・以降・最終便時刻を平日/土日祝ダイヤ別に確認できます。" />
    <meta name="robots" content="index,follow" />
    <meta name="keywords" content={keywords} />
    <meta name="author" content={siteAuthor} />
    <meta name="application-name" content="境町 ↔ 東京 高速バス ミニ" />
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="ja" href={overviewUrl} />
    <link rel="alternate" hreflang="ja" href={sakaiToTokyoUrl} />
    <link rel="alternate" hreflang="x-default" href={overviewUrl} />
    <link rel="prefetch" href={sakaiToTokyoUrl} as="document" />
    <link rel="prefetch" href={faqUrl} as="document" />
    <link rel="prefetch" href={guideUrl} as="document" />
    <link rel="manifest" href={manifestUrl} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content="東京 → 境町 高速バスの時刻表・次発案内" />
    <meta property="og:description" content="東京・王子から境町へ向かう高速バスの次の便や時刻表を掲載しています。" />
    <meta property="og:site_name" content="境町 ↔ 東京 高速バス ミニ" />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:image:width" content={ogImageWidth} />
    <meta property="og:image:height" content={ogImageHeight} />
    <meta property="og:locale" content="ja_JP" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={twitterHandle} />
    <meta name="twitter:creator" content={twitterHandle} />
    <meta name="twitter:title" content="東京 → 境町 高速バスの時刻表・次発案内" />
    <meta name="twitter:description" content="東京・王子から境町へ向かう次の高速バスをひと目で確認できます。" />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={ogImageAlt} />

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
    <Analytics />
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('{serviceWorkerPath}').catch(() => {});
        });
      }
    </script>
  </head>
  <body>
    <App
      client:load
      initialNowIso={initialNowIso}
      initialDirection="tokyo_to_sakai"
      initialTokyoStop="tokyo"
      currentView="tokyo_to_sakai"
      timetable={timetable}
    />
  </body>
</html>
